# Global settings
settings:
  execute_on_error: "error_handler_collect_nvdebug_logs"  # Global error handler

# Define optional flows
optional_flows:
  install_mft_flow:
    - name: install_mft_tools
      device_type: compute
      device_id: compute1
      operation: install_mft_tools
      parameters:
        tool_file_path: "${compute_bundles_folder}/${mft_bundle_name}"

  failure_ac_cycle_flow:
    - name: power_off_system
      tag: failure_ac_cycle_flow_power_off_system
      device_type: compute
      device_id: compute1
      operation: power_off
      parameters:
        base_uri: /redfish/v1/Systems/System_0/Actions/ComputerSystem.Reset
        data: {"ResetType": "ForceOff"}

    - name: ac_cycle_system
      device_type: compute
      device_id: compute1
      operation: ac_cycle
      parameters:
        base_uri: /redfish/v1/Chassis/BMC_0/Actions/Oem/NvidiaChassis.AuxPowerReset
        data: {"ResetType": "AuxPowerCycle"}
      jump_on_failure: failure_ac_cycle_flow_power_off_system
      wait_after_seconds: 180  # 3 minutes

    - name: check_hmc_ready
      device_type: compute
      device_id: compute1
      operation: wait_ap_ready
      retry_count: 1
      parameters:
        ap_name: 
          - HGX_FW_BMC_0
          - HGX_FW_ERoT_BMC_0
          - HGX_FW_ERoT_FPGA_0
          - HGX_FW_ERoT_FPGA_1
          - HGX_FW_ERoT_CPU_0
          - HGX_FW_ERoT_CPU_1
        timeout: 120
        base_uri: /redfish/v1/UpdateService/FirmwareInventory

    - name: check_erots_ready
      device_type: compute
      device_id: compute1
      operation: wait_ap_ready
      retry_count: 1
      parameters:
        ap_name: 
          - HGX_ERoT_CPU_0
          - HGX_ERoT_CPU_1
        timeout: 60
        base_uri: /redfish/v1/Chassis

    - name: optional_dot_cak_install
      device_type: compute
      device_id: compute1
      operation: dot_cak_install
      parameters:
        ap_name: HGX_ERoT_CPU_1
        pem_encoded_key: "${pem_encoded_key}"
        ap_firmware_signature: "${ap_firmware_signature}"
        base_uri: /redfish/v1/Chassis

    - name: optional_send_boot_ap_command
      device_type: compute
      device_id: compute1
      operation: send_boot_ap
      parameters:
        ap_name: HGX_ERoT_CPU_0
        base_uri: /redfish/v1/Chassis/
      wait_after_seconds: 10

    - name: optional_send_boot_ap_command
      device_type: compute
      device_id: compute1
      operation: send_boot_ap
      parameters:
        ap_name: HGX_ERoT_CPU_1
        base_uri: /redfish/v1/Chassis/
      wait_after_seconds: 10

steps:
  # Independent Parallel Flows
  - name: "Compute Tray Update Independent Flows"
    independent_flows:
      # Compute Tray Flow
      - name: "Compute Tray NIC Update Flow"
        steps:
          # Beginning of BF3/CX7/CX8 Update
          - name: check_hmc_ready
            device_type: compute
            device_id: compute1
            operation: wait_ap_ready
            retry_count: 1
            parameters:
              ap_name: 
                - HGX_FW_BMC_0
                - HGX_FW_ERoT_BMC_0
                - HGX_FW_ERoT_FPGA_0
                - HGX_FW_ERoT_FPGA_1
                - HGX_FW_ERoT_CPU_0
                - HGX_FW_ERoT_CPU_1
              timeout: 120
              base_uri: /redfish/v1/UpdateService/FirmwareInventory

          - name: check_erots_ready
            device_type: compute
            device_id: compute1
            operation: wait_ap_ready
            retry_count: 1
            parameters:
              ap_name: 
                - HGX_ERoT_CPU_0
                - HGX_ERoT_CPU_1
              timeout: 60
              base_uri: /redfish/v1/Chassis

          - name: optional_dot_cak_install
            device_type: compute
            device_id: compute1
            operation: dot_cak_install
            parameters:
              ap_name: HGX_ERoT_CPU_0
              pem_encoded_key: "${pem_encoded_key}"
              ap_firmware_signature: "${ap_firmware_signature}"
              base_uri: /redfish/v1/Chassis

          - name: optional_dot_cak_install
            device_type: compute
            device_id: compute1
            operation: dot_cak_install
            parameters:
              ap_name: HGX_ERoT_CPU_1
              pem_encoded_key: "${pem_encoded_key}"
              ap_firmware_signature: "${ap_firmware_signature}"
              base_uri: /redfish/v1/Chassis

          - name: optional_send_boot_ap_command
            device_type: compute
            device_id: compute1
            operation: send_boot_ap
            parameters:
              ap_name: HGX_ERoT_CPU_0
              base_uri: /redfish/v1/Chassis/
            wait_after_seconds: 10

          - name: optional_send_boot_ap_command
            device_type: compute
            device_id: compute1
            operation: send_boot_ap
            parameters:
              ap_name: HGX_ERoT_CPU_1
              base_uri: /redfish/v1/Chassis/
            wait_after_seconds: 10

          - name: wait_for_boot_to_os
            device_type: compute
            device_id: compute1
            operation: wait_for_boot
            retry_count: 1
            parameters:
              power_on_uri: /redfish/v1/Systems/System_0/Actions/ComputerSystem.Reset
              power_on_data: {"ResetType": "On"}
              system_uri: /redfish/v1/Systems/System_0
              state:
                - OSRunning
              timeout: 600
            execute_optional_flow: "failure_ac_cycle_flow"
            execute_on_error: "error_handler_boot_failure_gb300"

          - name: check_ssh_connection
            device_type: compute
            device_id: compute1
            operation: execute_os_command
            retry_count: 10
            wait_between_retries_seconds: 3
            parameters:
              command: echo "SSH connection successful"
              use_sudo: false

          - name: mst_start
            device_type: compute
            device_id: compute1
            operation: execute_os_command
            execute_optional_flow: "install_mft_flow"
            parameters:
              command: mst start
              use_sudo: true

          - name: scp_bf3_firmware_to_os
            device_type: compute
            device_id: compute1
            operation: scp_tool_to_os
            parameters:
              tool_file_path: "${compute_bundles_folder}/${bluefield_3_inband_image_name}"

          - name: scp_cx8_firmware_to_os
            device_type: compute
            device_id: compute1
            operation: scp_tool_to_os
            parameters:
              tool_file_path: "${compute_bundles_folder}/${connect_x8_inband_image_name}"

          - name: flint_flashing_bf3
            device_type: compute
            device_id: compute1
            operation: flint_flash
            parameters:
              named_device: BlueField3
              file_name: "${bluefield_3_inband_image_name}"

          - name: flint_flashing_cx8
            device_type: compute
            device_id: compute1
            operation: flint_flash
            parameters:
              named_device: ConnectX8
              file_name: "${connect_x8_inband_image_name}"

          - name: power_off_system
            device_type: compute
            device_id: compute1
            operation: power_off
            wait_after_seconds: 60
            parameters:
              base_uri: /redfish/v1/Systems/System_0/Actions/ComputerSystem.Reset
              data: {"ResetType": "ForceOff"}

          # cak install + boot AP here again
          - name: optional_dot_cak_install
            device_type: compute
            device_id: compute1
            operation: dot_cak_install
            parameters:
              ap_name: HGX_ERoT_CPU_0
              pem_encoded_key: "${pem_encoded_key}"
              ap_firmware_signature: "${ap_firmware_signature}"
              base_uri: /redfish/v1/Chassis

          - name: optional_dot_cak_install
            device_type: compute
            device_id: compute1
            operation: dot_cak_install
            parameters:
              ap_name: HGX_ERoT_CPU_1
              pem_encoded_key: "${pem_encoded_key}"
              ap_firmware_signature: "${ap_firmware_signature}"
              base_uri: /redfish/v1/Chassis

          - name: optional_send_boot_ap_command
            device_type: compute
            device_id: compute1
            operation: send_boot_ap
            parameters:
              ap_name: HGX_ERoT_CPU_0
              base_uri: /redfish/v1/Chassis/
            wait_after_seconds: 10

          - name: optional_send_boot_ap_command
            device_type: compute
            device_id: compute1
            operation: send_boot_ap
            parameters:
              ap_name: HGX_ERoT_CPU_1
              base_uri: /redfish/v1/Chassis/
            wait_after_seconds: 10

          - name: wait_for_boot_to_os
            device_type: compute
            device_id: compute1
            operation: wait_for_boot
            execute_on_error: "error_handler_boot_failure_gb300"
            parameters:
              power_on_uri: /redfish/v1/Systems/System_0/Actions/ComputerSystem.Reset
              power_on_data: {"ResetType": "On"}
              system_uri: /redfish/v1/Systems/System_0
              state:
                - OSRunning
              timeout: 600

          - name: mst_start
            device_type: compute
            device_id: compute1
            operation: execute_os_command
            parameters:
              command: mst start
              use_sudo: true

          - name: flint_verification_bf3
            device_type: compute
            device_id: compute1
            operation: flint_verify
            parameters:
              named_device: BlueField3
              file_name: "${bluefield_3_inband_image_name}"

          - name: flint_verification_cx8
            device_type: compute
            device_id: compute1
            operation: flint_verify
            parameters:
              named_device: ConnectX8
              file_name: "${connect_x8_inband_image_name}"

          - name: mst_stop
            device_type: compute
            device_id: compute1
            operation: execute_os_command
            parameters:
              command: mst stop
              use_sudo: true
